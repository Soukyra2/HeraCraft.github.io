<!DOCTYPE html>
<html lang="fr">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta charset="UTF-8" />
  <title>Serveur PvP Faction - Gestion</title>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif; background: #121212; color: #fff;
    }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px; background: #1f1f1f;
    }
    .logo {
      font-size: 1.5em; font-weight: bold; color: #0af;
    }
    nav a {
      color: #fff; text-decoration: none; margin-left: 20px; cursor: pointer;
    }
    nav a:hover {
      color: #0af;
    }
    .content {
      padding: 40px;
      max-width: 900px;
      margin: auto;
      position: relative; /* Needed for z-index of sections */
    }
    .section {
      display: none;
      position: relative;
      z-index: 1; /* Ensures content is above background */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      padding: 40px; /* Adjust padding to make space for content */
      min-height: 500px; /* Ensure sections have height for background */
      box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.6); /* Dark overlay for readability */
      border-radius: 10px;
      overflow: hidden; /* Hide any overflow if image is too big */
    }
    .section.active {
      display: block;
    }
    form {
      background: #222; padding: 20px; border-radius: 10px; max-width: 350px;
    }
    input[type="text"],
    input[type="password"],
    textarea,
    input[type="number"],
    select {
      width: 100%; padding: 8px; margin-top: 10px; margin-bottom: 20px;
      border: none; border-radius: 5px; background: #333; color: white;
      resize: vertical;
    }
    input[type="submit"], button {
      background: #0af; color: #fff; border: none; padding: 10px;
      border-radius: 5px; cursor: pointer;
    }
    input[type="submit"]:hover, button:hover {
      background: #08c;
    }
    table {
      width: 100%; border-collapse: collapse; background: #1e1e1e; margin-top: 20px;
    }
    th, td {
      padding: 10px; border: 1px solid #444; text-align: center;
    }
    th {
      background: #0af;
    }
    .staff-item {
      display: flex; justify-content: space-between; align-items: center; margin: 5px 0;
      background: #2a2a2a;
      padding: 8px 10px;
      border-radius: 5px;
    }
    .staff-item span {
      flex: 1;
      margin-right: 10px;
    }
    .staff-item button {
      padding: 4px 8px; font-size: 0.9em; border: none;
      cursor: pointer; color: white; border-radius: 3px;
      margin-left: 5px;
    }
    .staff-item button.delete-btn {
      background: red;
    }
    .staff-item button.edit-btn {
      background: #ffc107; /* Yellow for edit */
      color: #333;
    }
    .staff-item button.move-btn {
      background: #555; /* Gray for move buttons */
    }
    .staff-item button.move-btn:hover {
      background: #777;
    }
    /* Scrollbar pour listes */
    #annoncesList, #problemesList, #autresList, #shopItems, #pendingNotifications, #onHoldNotifications, #doneNotifications, #onlineUsersList, #messagesDisplay {
      scrollbar-width: thin;
      scrollbar-color: #0af #222;
      max-height: 200px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    #annoncesList::-webkit-scrollbar, #problemesList::-webkit-scrollbar, #autresList::-webkit-scrollbar, #shopItems::-webkit-scrollbar, #pendingNotifications::-webkit-scrollbar, #onHoldNotifications::-webkit-scrollbar, #doneNotifications::-webkit-scrollbar, #onlineUsersList::-webkit-scrollbar, #messagesDisplay::-webkit-scrollbar {
      width: 6px;
    }
    #annoncesList::-webkit-scrollbar-thumb, #problemesList::-webkit-scrollbar-thumb, #autresList::-webkit-scrollbar-thumb, #shopItems::-webkit-scrollbar-thumb, #pendingNotifications::-webkit-scrollbar-thumb, #onHoldNotifications::-webkit-scrollbar-thumb, #doneNotifications::-webkit-scrollbar-thumb, #onlineUsersList::-webkit-scrollbar-thumb, #messagesDisplay::-webkit-scrollbar-thumb {
      background-color: #0af;
      border-radius: 3px;
    }
    .message {
      border-bottom: 1px solid #333;
      padding: 5px 0;
    }
    .message strong {
      color: #0af;
    }
    /* Shop specific styles */
    .shop-item-grid, .shop-grade-grid { /* Renamed for clarity */
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .shop-grade-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Adjusted for up to 4 items */
    }
    @media (min-width: 800px) { /* Adjust breakpoint as needed */
      .shop-grade-grid {
        grid-template-columns: repeat(4, 1fr); /* Exactly 4 columns */
      }
    }
    .shop-item, .shop-grade-item { /* Renamed for clarity */
      background: #222;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .shop-item h3, .shop-grade-item h3 {
      margin-top: 0;
      color: #0af;
    }
    .shop-item p, .shop-grade-item p {
      margin-bottom: 10px;
    }
    .shop-item button, .shop-grade-item button {
      width: 100%;
      padding: 8px;
      background: #0af;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .shop-item button:hover, .shop-grade-item button:hover {
      background: #08c;
    }
    .shop-item .admin-controls button, .shop-grade-item .admin-controls button {
        background: red;
        margin-top: 5px;
    }
    /* Notification item styling */
    .notification-item {
        background: #2a2a2a;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .notification-item.status-done {
        background: #223a22; /* Greenish for done */
    }
    .notification-item.status-onhold {
        background: #3a3a22; /* Yellowish for on hold */
    }
    .notification-item .notif-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .notification-item .notif-status {
        font-weight: bold;
        color: #0af;
    }
    .notification-item .notif-date {
        font-size: 0.8em;
        color: #bbb;
    }
    .notification-item .notif-message {
        font-size: 1.1em;
        margin-top: 5px;
    }
    .notification-item .notif-actions button {
        margin-right: 5px;
        padding: 5px 10px;
        font-size: 0.9em;
    }
    .notification-item .notif-actions button.mark-done { background: #28a745; } /* Green */
    .notification-item .notif-actions button.put-hold { background: #ffc107; color: #333;} /* Yellow */
    .notification-item .notif-actions button.delete-notif { background: #dc3545; } /* Red */

    /* Server Status Specific Styles */
    #serverStatusDisplay {
      font-size: 2.5em;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #serverStatusDisplay.status-open {
      color: #28a745; /* Green */
      background: #1f2f1f;
    }
    #serverStatusDisplay.status-closed {
      color: #dc3545; /* Red */
      background: #2f1f2f;
    }
    #serverStatusDisplay.status-development {
      color: #ffc107; /* Yellow */
      background: #2f2f1f;
    }
    #serverStatusAdminForm {
      margin-top: 30px;
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    #onlineUsersList .online-user-item {
        background: #2a2a2a;
        padding: 8px 10px;
        margin-bottom: 5px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #onlineUsersList .online-user-item strong {
        color: #0af;
    }
    #onlineUsersList .online-user-item span {
        font-size: 0.8em;
        color: #bbb;
    }
    /* New styles for user management table input */
    .user-table-gems-input {
      width: 60px;
      margin-right: 5px;
      margin-bottom: 0;
    }
    #playerGemsDisplay {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #0af;
    }
    .sub-section-title {
        margin-top: 40px;
        margin-bottom: 20px;
        font-size: 1.8em;
        color: #0af;
        border-bottom: 2px solid #0af;
        padding-bottom: 5px;
    }
    /* Admin Background Controls */
    .admin-background-controls {
        background: rgba(0, 0, 0, 0.7); /* Semi-transparent background */
        padding: 10px;
        margin-top: 20px;
        border-radius: 8px;
        display: none; /* Hidden by default, shown for admins */
        flex-direction: column; /* Stack elements vertically */
        gap: 10px;
        position: absolute; /* Position relative to .section */
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 10; /* Above other content */
    }
    .admin-background-controls.active {
      display: flex; /* Show when 'active' class is present */
    }
    .admin-background-controls label {
        font-size: 0.9em;
        color: #ccc;
    }
    .admin-background-controls .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        flex-wrap: wrap;
    }
    .admin-background-controls input[type="file"] {
        display: none; /* Hide default file input */
    }
    .admin-background-controls .file-upload-button {
        background: #0af;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        white-space: nowrap;
    }
    .admin-background-controls .file-upload-button:hover {
        background: #08c;
    }
    .admin-background-controls input[type="text"] {
        flex-grow: 1; /* Input takes available space */
        margin: 0;
        min-width: 200px; /* Ensure input is not too small */
    }
    .admin-background-controls button {
        white-space: nowrap; /* Prevent button text from wrapping */
        margin: 0;
    }
    .admin-background-controls button.delete-image-btn {
        background: #dc3545; /* Red color for delete */
    }
    .admin-background-controls .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: none; /* Hidden by default */
        margin-left: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Admin Toggle for Background */
    #adminBgToggleContainer {
      display: none; /* Hidden by default, shown when admin logged in */
      margin-top: 10px;
      text-align: right;
      padding: 10px 20px;
      background: #2a2a2a;
      border-radius: 8px;
    }
    #adminBgToggleContainer label {
      margin-left: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Styles for Messages Section */
    #messagesSection {
        display: flex;
        flex-direction: row;
        gap: 20px;
        min-height: 500px;
        position: relative; /* For admin controls */
    }
    #conversationList {
        flex: 0 0 250px; /* Fixed width for contact list */
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    #conversationList h2 {
        margin-top: 0;
        color: #0af;
        font-size: 1.4em;
    }
    #searchUserContainer {
        margin-bottom: 15px;
        display: flex;
        gap: 5px;
    }
    #searchUserInput {
        flex-grow: 1;
        background: #333;
        border: 1px solid #444;
        padding: 8px;
        border-radius: 5px;
        color: white;
    }
    #searchUserButton {
        background: #0af;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
    }
    #searchUserButton:hover {
        background: #08c;
    }
    #searchResults {
        margin-top: 10px;
        border-top: 1px solid #444;
        padding-top: 10px;
    }
    .user-contact-item, .search-result-item {
        padding: 10px;
        margin-bottom: 5px;
        background: #333;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .user-contact-item:hover, .search-result-item:hover {
        background: #444;
    }
    .user-contact-item.active {
        background: #0af;
        font-weight: bold;
    }
    #chatWindow {
        flex-grow: 1;
        background: #222;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    #chatHeader {
        font-size: 1.5em;
        color: #0af;
        margin-bottom: 15px;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
    }
    #messagesDisplay {
        flex-grow: 1;
        overflow-y: auto;
        max-height: 400px;
        background: #1a1a1a;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        scrollbar-width: thin;
        scrollbar-color: #0af #1a1a1a;
    }
    #messagesDisplay::-webkit-scrollbar {
        width: 6px;
    }
    #messagesDisplay::-webkit-scrollbar-thumb {
        background-color: #0af;
        border-radius: 3px;
    }
    .chat-message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 8px;
        word-wrap: break-word;
        max-width: 80%;
    }
    .chat-message strong {
        color: #0af;
    }
    .chat-message.self {
        background: #0af;
        align-self: flex-end;
        text-align: right;
        margin-left: auto;
        color: white;
    }
    .chat-message.other {
        background: #444;
        align-self: flex-start;
        text-align: left;
        margin-right: auto;
        color: white;
    }
    .chat-input-container {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    #messageInput {
        flex-grow: 1;
        background: #333;
        border: 1px solid #444;
        padding: 10px;
        border-radius: 5px;
        color: white;
        resize: none;
    }
    #sendMessageButton {
        background: #0af;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
    }
    #sendMessageButton:hover {
        background: #08c;
    }
    .error-message {
        color: red;
        font-size: 0.9em;
        margin-top: 5px;
    }
    /* Styles for Admin Messages */
    .admin-only-controls {
        background: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none; /* Hidden by default */
    }
    .admin-only-controls textarea {
        width: calc(100% - 20px);
        margin-bottom: 10px;
    }
    .admin-only-controls button {
        width: auto;
        padding: 8px 15px;
    }
    .admin-only-controls button:first-of-type {
      margin-right: 10px;
    }

    /* Global Message Banner */
    #globalMessageBanner {
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #0af; /* Blue accent */
        color: white;
        text-align: center;
        padding: 10px;
        font-weight: bold;
        z-index: 100; /* Above other content */
        display: none; /* Hidden by default */
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="globalMessageBanner"></div>
  <header>
    <div class="logo">PvP Faction</div>
    <nav id="navbar">
      <a onclick="showSection('home')">Home</a>
      <a onclick="showSection('join')">Comment rejoindre</a>
      <a onclick="showSection('staff')">Staff</a>
      <a onclick="showSection('wiki')">Wiki</a>
      <a onclick="showSection('shop')">Shop</a>
      <a id="notificationsNav" style="display:none;" onclick="showSection('notifications')">Notifications</a>
      <a onclick="showSection('status')">Statut Serveur</a>
      <a id="onlineUsersNav" style="display:none;" onclick="showSection('onlineUsers')">Qui est en ligne</a>
      <a onclick="showSection('discussion')">Discussion</a>
      <a id="loginNav" onclick="showSection('login')">Se connecter</a>
      <a id="registerNav" onclick="showSection('register')">Créer un compte</a>
    </nav>
  </header>

  <div id="adminBgToggleContainer">
    <input type="checkbox" id="toggleAdminBgControls" onchange="updateAdminBackgroundControlsVisibility()">
    <label for="toggleAdminBgControls">Mode Admin Fond</label>
  </div>

  <div class="content">
    <div id="home" class="section active">
      <h1>Bienvenue sur notre serveur PvP Faction</h1>
      <p>Un serveur sans mods, full survie, et plein de guerres épiques !</p>
       <div id="homeAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Home):</label>
            <div class="input-group">
                <input type="file" id="homeBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'home')">
                <button class="file-upload-button" onclick="document.getElementById('homeBgFileInput').click()">Choisir une image</button>
                <input type="text" id="homeBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="homeSpinner" class="spinner"></div>
                <button onclick="saveBackground('home')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('home')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="join" class="section">
      <h1>Comment rejoindre</h1>
      <p>IP : <strong>dev</strong><br />Version : <strong>1.16.5</strong></p>
      <div id="joinAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Rejoindre):</label>
            <div class="input-group">
                <input type="file" id="joinBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'join')">
                <button class="file-upload-button" onclick="document.getElementById('joinBgFileInput').click()">Choisir une image</button>
                <input type="text" id="joinBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="joinSpinner" class="spinner"></div>
                <button onclick="saveBackground('join')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('join')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="staff" class="section">
      <h1>Notre Staff</h1>
      <ul id="staffList"></ul>

      <div id="addStaffForm" style="margin-top: 20px; display: none;">
        <h3>Ajouter un membre au staff</h3>
        <input type="text" id="newStaffPseudo" placeholder="Pseudo" />
        <input type="text" id="newStaffRole" placeholder="Rôle" />
        <button onclick="addStaffMember()">Ajouter</button>
      </div>
      <div id="staffAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Staff):</label>
            <div class="input-group">
                <input type="file" id="staffBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'staff')">
                <button class="file-upload-button" onclick="document.getElementById('staffBgFileInput').click()">Choisir une image</button>
                <input type="text" id="staffBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="staffSpinner" class="spinner"></div>
                <button onclick="saveBackground('staff')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('staff')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="wiki" class="section">
      <h1>Wiki du serveur</h1>

      <section style="margin-bottom: 40px;">
        <h2>📢 Annonces (Admins uniquement)</h2>
        <div id="annoncesList"><i>Chargement...</i></div>
        <div id="annoncesForm" style="margin-top: 10px; display: none;">
          <textarea id="annonceInput" rows="3" placeholder="Écrire une annonce..."></textarea><br />
          <button onclick="postAnnonce()">Envoyer</button>
        </div>
        <small>Seuls les admins peuvent poster ici.</small>
      </section>

      <section style="margin-bottom: 40px;">
        <h2>❗ Problèmes</h2>
        <div id="problemesList"><i>Chargement...</i></div>
        <div id="problemesForm" style="margin-top: 10px; display: none;">
          <textarea id="problemeInput" rows="3" placeholder="Décrire un problème..."></textarea><br />
          <button onclick="postProbleme()">Envoyer</button>
        </div>
      </section>

      <section>
        <h2>🔧 Autres</h2>
        <div id="autresList"><i>Chargement...</i></div>
        <div id="autresForm" style="margin-top: 10px; display: none;">
          <textarea id="autreInput" rows="3" placeholder="Écrire ici..."></textarea><br />
          <button onclick="postAutre()">Envoyer</button>
        </div>
      </section>
      <div id="wikiAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Wiki):</label>
            <div class="input-group">
                <input type="file" id="wikiBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'wiki')">
                <button class="file-upload-button" onclick="document.getElementById('wikiBgFileInput').click()">Choisir une image</button>
                <input type="text" id="wikiBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="wikiSpinner" class="spinner"></div>
                <button onclick="saveBackground('wiki')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('wiki')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="shop" class="section">
      <h1>Boutique du Serveur</h1>
      <p>Achetez des articles uniques et des grades pour améliorer votre expérience PvP Faction !</p>

      <p id="playerGemsDisplayShop" style="text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 20px;"></p>

      <h2 class="sub-section-title">Articles de la boutique</h2>
      <div id="addShopItemForm" style="display:none; margin-top: 20px; margin-bottom: 40px;">
        <h3>Ajouter un article au Shop (Admin)</h3>
        <input type="text" id="newItemName" placeholder="Nom de l'article" />
        <input type="number" id="newItemPrice" placeholder="Prix en gemmes" min="0" />
        <textarea id="newItemDescription" rows="2" placeholder="Description de l'article"></textarea>
        <button onclick="addShopItem()">Ajouter l'article</button>
      </div>
      <div id="shopItems" class="shop-item-grid">
        <i>Chargement des articles...</i>
      </div>

      <h2 class="sub-section-title">Grades du Serveur</h2>
      <div id="addGradeItemForm" style="display:none; margin-top: 20px; margin-bottom: 40px;">
          <h3>Ajouter un Grade (Admin)</h3>
          <input type="text" id="newGradeName" placeholder="Nom du grade" />
          <input type="number" id="newGradeCost" placeholder="Coût en gemmes" min="0" />
          <textarea id="newGradeDescription" rows="2" placeholder="Description du grade"></textarea>
          <button onclick="addGradeItem()">Ajouter le Grade</button>
      </div>
      <div id="gradesList" class="shop-grade-grid">
          <i>Chargement des grades...</i>
      </div>
      <div id="shopAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Shop):</label>
            <div class="input-group">
                <input type="file" id="shopBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'shop')">
                <button class="file-upload-button" onclick="document.getElementById('shopBgFileInput').click()">Choisir une image</button>
                <input type="text" id="shopBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="shopSpinner" class="spinner"></div>
                <button onclick="saveBackground('shop')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('shop')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="notifications" class="section">
      <h1>Notifications des Achats (Staff uniquement)</h1>
      <p>Gérez les demandes d'achat des joueurs ici.</p>

      <h3>En cours (Pending)</h3>
      <div id="pendingNotifications"><i>Aucune notification en cours.</i></div>

      <h3>En attente (On Hold)</h3>
      <div id="onHoldNotifications"><i>Aucune notification en attente.</i></div>

      <h3>Traitées (Done)</h3>
      <div id="doneNotifications"><i>Aucune notification traitée.</i></div>
      <div id="notificationsAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Notifications):</label>
            <div class="input-group">
                <input type="file" id="notificationsBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'notifications')">
                <button class="file-upload-button" onclick="document.getElementById('notificationsBgFileInput').click()">Choisir une image</button>
                <input type="text" id="notificationsBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="notificationsSpinner" class="spinner"></div>
                <button onclick="saveBackground('notifications')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('notifications')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="status" class="section">
        <h1>Statut du Serveur</h1>
        <div id="serverStatusDisplay" class="status-loading">Chargement du statut...</div>

        <div id="serverStatusAdminForm" style="display:none;">
            <h3>Modifier le statut du serveur (Admin)</h3>
            <select id="newServerStatus">
                <option value="open">Ouvert</option>
                <option value="closed">Fermé</option>
                <option value="development">En Développement</option>
            </select>
            <button onclick="updateServerStatus()">Mettre à jour le statut</button>
        </div>
        <div id="statusAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Statut):</label>
            <div class="input-group">
                <input type="file" id="statusBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'status')">
                <button class="file-upload-button" onclick="document.getElementById('statusBgFileInput').click()">Choisir une image</button>
                <input type="text" id="statusBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="statusSpinner" class="spinner"></div>
                <button onclick="saveBackground('status')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('status')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="onlineUsers" class="section">
        <h1>Qui est en ligne</h1>
        <p>Utilisateurs actuellement connectés au site :</p>
        <div id="onlineUsersList"><i>Chargement des utilisateurs en ligne...</i></div>
        <div id="onlineUsersAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Utilisateurs en ligne):</label>
            <div class="input-group">
                <input type="file" id="onlineUsersBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'onlineUsers')">
                <button class="file-upload-button" onclick="document.getElementById('onlineUsersBgFileInput').click()">Choisir une image</button>
                <input type="text" id="onlineUsersBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="onlineUsersSpinner" class="spinner"></div>
                <button onclick="saveBackground('onlineUsers')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('onlineUsers')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="discussion" class="section">
      <h1>Discussion</h1>
      <p>Rejoins notre Discord !</p>
      <a href="https://discord.com/invite/tonserveur" target="_blank" style="color:#0af;">→ Discord</a>
      <div id="discussionAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Discussion):</label>
            <div class="input-group">
                <input type="file" id="discussionBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'discussion')">
                <button class="file-upload-button" onclick="document.getElementById('discussionBgFileInput').click()">Choisir une image</button>
                <input type="text" id="discussionBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="discussionSpinner" class="spinner"></div>
                <button onclick="saveBackground('discussion')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('discussion')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="login" class="section">
      <h1>Connexion</h1>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <label>Nom d'utilisateur</label>
        <input type="text" id="loginUsername" required />
        <label>Mot de passe</label>
        <input type="password" id="loginPassword" required />
        <input type="submit" value="Se connecter" />
      </form>
      <div id="loginAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Connexion):</label>
            <div class="input-group">
                <input type="file" id="loginBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'login')">
                <button class="file-upload-button" onclick="document.getElementById('loginBgFileInput').click()">Choisir une image</button>
                <input type="text" id="loginBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="loginSpinner" class="spinner"></div>
                <button onclick="saveBackground('login')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('login')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="register" class="section">
      <h1>Créer un compte</h1>
      <form id="registerForm" onsubmit="handleRegister(event)">
        <label>Nom d'utilisateur</label>
        <input type="text" id="registerUsername" required />
        <label>Mot de passe</label>
        <input type="password" id="registerPassword" required />
        <input type="submit" value="Créer le compte" />
      </form>
      <div id="registerAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Inscription):</label>
            <div class="input-group">
                <input type="file" id="registerBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'register')">
                <button class="file-upload-button" onclick="document.getElementById('registerBgFileInput').click()">Choisir une image</button>
                <input type="text" id="registerBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="registerSpinner" class="spinner"></div>
                <button onclick="saveBackground('register')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('register')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="compte" class="section">
      <h1>Mon Compte</h1>
      <p id="playerInfo">Chargement des informations...</p>

      <h2 class="sub-section-title">Gestion des utilisateurs (Admin seulement)</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Admin</th>
            <th>Gemmes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr><td colspan="4">Accès administrateur requis pour la gestion des utilisateurs.</td></tr>
        </tbody>
      </table>
      <div id="compteAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Compte):</label>
            <div class="input-group">
                <input type="file" id="compteBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'compte')">
                <button class="file-upload-button" onclick="document.getElementById('compteBgFileInput').click()">Choisier une image</button>
                <input type="text" id="compteBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="compteSpinner" class="spinner"></div>
                <button onclick="saveBackground('compte')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('compte')">Supprimer l'image</button>
            </div>
        </div>
    </div>

    <div id="messages" class="section">
        <h1>Messagerie</h1>
        <div id="messagesSection">
            <div id="conversationList">
                <h2>Mes Conversations Privées</h2>
                <div id="searchUserContainer">
                    <input type="text" id="searchUserInput" placeholder="Rechercher un utilisateur..." />
                    <button id="searchUserButton" onclick="searchUserForChat()">Rechercher</button>
                </div>
                <div id="searchResults"></div>
                <hr style="border-color: #444; margin: 15px 0;">
                <div id="recentConversations">
                    <p><i>Aucune conversation récente.</i></p>
                </div>

                <div id="adminChatNavLink" style="display: none; margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
                    <button class="user-contact-item" onclick="startAdminChat()">Discussion Admin</button>
                </div>
            </div>

            <div id="chatWindow">
                <h2 id="chatHeader">Sélectionnez une conversation</h2>
                <div id="messagesDisplay">
                    <p style="text-align: center; color: #aaa;">Sélectionnez ou recherchez un utilisateur pour commencer à discuter.</p>
                </div>
                <div class="chat-input-container">
                    <textarea id="messageInput" placeholder="Écrire un message..." rows="1"></textarea>
                    <button id="sendMessageButton" onclick="sendMessage()">Envoyer</button>
                </div>
                <div id="chatError" class="error-message" style="display: none;"></div>
            </div>
        </div>
        <div id="adminMessageControls" class="admin-only-controls">
            <h2>Envoyer un message global aux joueurs</h2>
            <textarea id="globalMessageInput" rows="3" placeholder="Message à envoyer à tous les joueurs..."></textarea>
            <button onclick="sendGlobalMessage()">Envoyer à tous</button>
            <button onclick="clearGlobalMessage()" style="background: red;">Effacer le message global</button>
            <div id="globalMessageStatus" class="error-message" style="color: #0af;"></div>
        </div>
        <div id="messagesAdminBgControls" class="admin-background-controls">
            <label>Image de fond (Messages):</label>
            <div class="input-group">
                <input type="file" id="messagesBgFileInput" accept="image/*" onchange="handleImageUpload(event, 'messages')">
                <button class="file-upload-button" onclick="document.getElementById('messagesBgFileInput').click()">Choisir une image</button>
                <input type="text" id="messagesBgUrl" placeholder="URL de l'image ou téléchargez" />
                <div id="messagesSpinner" class="spinner"></div>
                <button onclick="saveBackground('messages')">Sauvegarder</button>
                <button class="delete-image-btn" onclick="deleteBackground('messages')">Supprimer l'image</button>
            </div>
        </div>
    </div>

  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>

function isMobile() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}

window.addEventListener('DOMContentLoaded', () => {
  // Variable pour savoir si le navigateur supporte le prompt d'installation PWA
  let canInstallPWA = false;

  // Ecoute de l'événement beforeinstallprompt (support PWA)
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); // empêcher l'affichage automatique
    canInstallPWA = true; // On peut proposer l'installation

    // On lance la fonction si c'est mobile et supporte PWA
    if (isMobile()) {
      setupMobileMenu();
    }
  });

  // Aussi, si on arrive et que l'event n'a pas été déclenché mais c'est desktop, on ne fait rien
  // Si c'est mobile mais pas support PWA, pas de menu toggle

  // En plus, si la page est déjà chargée et qu'on a le flag canInstallPWA à true, on fait pareil (cas rare)
  if (isMobile() && canInstallPWA) {
    setupMobileMenu();
  }

  function setupMobileMenu() {
    // Injecter le style seulement pour mobile + PWA capable
    const style = document.createElement('style');
    style.textContent = `
      #navbarToggleBtn {
        background-color: #007bff;
        color: white;
        border: none;
        width: 100%;
        padding: 12px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        text-align: left;
        box-sizing: border-box;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      #navbar a {
        display: block;
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        text-decoration: none;
        color: #333;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      #navbar a:hover {
        background-color: #f0f0f0;
      }

      #navbar {
        width: 100%;
        box-sizing: border-box;
        background-color: #fafafa;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    `;
    document.head.appendChild(style);

    const navbar = document.getElementById('navbar');
    Array.from(navbar.querySelectorAll('a')).forEach(a => a.style.display = 'none');

    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'navbarToggleBtn';
    toggleBtn.textContent = 'Menu ▾';
    navbar.parentNode.insertBefore(toggleBtn, navbar);

    toggleBtn.addEventListener('click', () => {
      const isVisible = navbar.querySelector('a').style.display === 'block';
      Array.from(navbar.querySelectorAll('a')).forEach(a => {
        a.style.display = isVisible ? 'none' : 'block';
      });
      toggleBtn.textContent = isVisible ? 'Menu ▾' : 'Fermer ✕';
    });
  }
});


    // Config Firebase (remplace par la tienne)
    const firebaseConfig = {
      apiKey: "AIzaSyBopmWDhmWN8EAZOdl07FXj0LhWJj-ibZA",
      authDomain: "heracraft-e65b2.firebaseapp.com",
      databaseURL: "https://heracraft-e65b2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "heracraft-e65b2",
      storageBucket: "heracraft-e65b2.appspot.com",
      messagingSenderId: "213150508807",
      appId: "1:213150508807:web:5d2b604a115571ea2487a2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

  // Variables d'état
  let currentUser = null;
  let currentSection = 'home';
  let backgrounds = {};
  let activeChatPartner = null;
  let currentMessagesListener = null;
  const messageTimestamps = {};
  const MAX_MESSAGES_PER_SECOND = 3;
  const MESSAGE_RATE_LIMIT_DURATION = 1000;

  // Backgrounds listener
  let backgroundsListener = null;
  let globalMessageListener = null;

  // --- UTILITY FUNCTIONS ---

  // Met à jour la visibilité des éléments de l'interface en fonction du statut admin
  function updateUIForAdminStatus() {
      const isAdmin = currentUser && currentUser.admin;
      const isLoggedIn = currentUser !== null;

      // Navigation links
      document.getElementById('notificationsNav').style.display = isAdmin ? 'inline' : 'none';
      document.getElementById('onlineUsersNav').style.display = isAdmin ? 'inline' : 'none';

      const messagesNav = document.getElementById('messagesNav');
      if (messagesNav) messagesNav.style.display = isLoggedIn ? 'inline' : 'none';

      // Admin Group Chat Nav Link
      const adminChatNavLink = document.getElementById('adminChatNavLink');
      if (adminChatNavLink) {
          adminChatNavLink.style.display = isAdmin ? 'block' : 'none';
      }

      // Admin Message Controls (for global messages)
      const adminMessageControls = document.getElementById('adminMessageControls');
      if (adminMessageControls) {
          adminMessageControls.style.display = isAdmin ? 'block' : 'none';
      }

      // Admin Background Toggle
      document.getElementById('adminBgToggleContainer').style.display = isAdmin ? 'block' : 'none';
      if (!isAdmin) {
          document.getElementById('toggleAdminBgControls').checked = false;
      }
      updateAdminBackgroundControlsVisibility();

      // Staff section specific elements
      document.getElementById('addStaffForm').style.display = isAdmin ? 'block' : 'none';
      if (currentSection === 'staff') {
          loadStaff(); // Re-render staff list to update buttons
      }

      // Wiki section specific elements
      document.getElementById('annoncesForm').style.display = isAdmin ? 'block' : 'none';

      // Shop section specific elements
      document.getElementById('addShopItemForm').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('addGradeItemForm').style.display = isAdmin ? 'block' : 'none';
      if (currentSection === 'shop') {
          loadShopAndGrades(); // Re-render shop/grades to update buttons
      }

      // Server Status admin form
      document.getElementById('serverStatusAdminForm').style.display = isAdmin ? 'block' : 'none';

      // 'Compte' section specific elements (table and its content)
      const usersTable = document.getElementById('usersTable');
      if (usersTable) {
          usersTable.style.display = isAdmin ? 'table' : 'none';
      }
      const playerInfo = document.getElementById('playerInfo');
      if (playerInfo) {
          if (currentUser) {
              playerInfo.innerHTML = `Bonjour **${currentUser.username}** !<br>Vos gemmes : **${currentUser.gems || 0}** 💎<br>Statut Admin : **${currentUser.admin ? 'Oui' : 'Non'}**`;
          } else {
              playerInfo.textContent = "Connectez-vous pour voir vos informations de compte.";
          }
      }
      if (currentSection === 'compte' && isAdmin) {
          loadUsers();
      } else if (currentSection === 'compte' && !isAdmin) {
          document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="4">Accès administrateur requis pour la gestion des utilisateurs.</td></tr>';
      }

      // Global forms visibility
      document.getElementById('problemesForm').style.display = isLoggedIn ? 'block' : 'none';
      document.getElementById('autresForm').style.display = isLoggedIn ? 'block' : 'none';
  }

  // Afficher une section
  function showSection(section) {
    if(section === currentSection) return;
    currentSection = section;

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    const activeSectionElement = document.getElementById(section);
    if (activeSectionElement) {
        activeSectionElement.classList.add('active');
    }

    applyBackground(section);

    if(section === 'staff') loadStaff();
    if(section === 'wiki') loadWiki();
    if(section === 'shop') loadShopAndGrades();
    if(section === 'notifications') {
        if (!currentUser || !currentUser.admin) {
            alert('Accès réservé aux admins.');
            showSection('home');
        } else {
            loadNotifications();
        }
    }
    if(section === 'status') loadServerStatus();
    if(section === 'onlineUsers') {
        if (!currentUser || !currentUser.admin) {
            alert('Accès réservé aux admins.');
            showSection('home');
        } else {
            loadOnlineUsers();
        }
    }
    if(section === 'compte') {
      const playerInfo = document.getElementById('playerInfo');
      const usersTable = document.getElementById('usersTable');
      if (currentUser) {
          playerInfo.innerHTML = `Bonjour **${currentUser.username}** !<br>Vos gemmes : **${currentUser.gems || 0}** 💎<br>Statut Admin : **${currentUser.admin ? 'Oui' : 'Non'}**`;
          if (currentUser.admin) {
              usersTable.style.display = 'table';
              loadUsers();
          } else {
              usersTable.style.display = 'none';
              document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="4">Accès administrateur requis pour la gestion des utilisateurs.</td></tr>';
          }
      } else {
          playerInfo.textContent = "Connectez-vous pour voir vos informations de compte.";
          usersTable.style.display = 'none';
      }
    }
    if (section === 'messages') {
        if (!currentUser) {
            alert('Vous devez être connecté pour accéder à la messagerie.');
            showSection('login');
        } else {
            loadRecentConversations();
            resetChatWindow();
            updateUIForAdminStatus();
        }
    } else {
        if (currentMessagesListener) {
            db.ref('messages').off('value', currentMessagesListener);
            currentMessagesListener = null;
        }
        activeChatPartner = null;
    }
    updateAdminBackgroundControlsVisibility();
  }

  // Met à jour la nav selon statut utilisateur
  function updateNav() {
    const loginNav = document.getElementById('loginNav');
    const registerNav = document.getElementById('registerNav');

    const existingLogoutNav = document.getElementById('logoutNav');
    if (existingLogoutNav) existingLogoutNav.remove();
    const existingCompteNav = document.getElementById('compteNav');
    if (existingCompteNav) existingCompteNav.remove();
    const existingMessagesNav = document.getElementById('messagesNav');
    if (existingMessagesNav) existingMessagesNav.remove();

    if(currentUser) {
      loginNav.style.display = 'none';
      registerNav.style.display = 'none';

      const nav = document.getElementById('navbar');

      const messages = document.createElement('a');
      messages.id = 'messagesNav';
      messages.textContent = 'Messages';
      messages.onclick = () => showSection('messages');
      const discussionNav = document.querySelector('nav a[onclick*="discussion"]');
      if (discussionNav) {
          nav.insertBefore(messages, discussionNav);
      } else {
          nav.appendChild(messages);
      }

      const compte = document.createElement('a');
      compte.id = 'compteNav';
      compte.textContent = 'Compte';
      compte.onclick = () => showSection('compte');
      if (discussionNav) {
          nav.insertBefore(compte, discussionNav.nextSibling);
      } else {
          nav.appendChild(compte);
      }

      const logout = document.createElement('a');
      logout.id = 'logoutNav';
      logout.textContent = 'Déconnexion';
      logout.onclick = logoutUser;
      nav.appendChild(logout);

    } else {
      loginNav.style.display = 'inline';
      registerNav.style.display = 'inline';
    }
    updateUIForAdminStatus();
  }

  // Connexion
  function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if(!username || !password) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    db.ref('users/' + username).once('value').then(snap => {
      const user = snap.val();
      if(!user) {
        alert('Utilisateur inconnu');
        return;
      }
      if(user.password !== password) {
        alert('Mot de passe incorrect');
        return;
      }
      currentUser = {
          username: username,
          admin: user.admin || false,
          staff: user.staff || false,
          role: user.role || '',
          gems: user.gems || 0
      };
      alert('Connecté en tant que ' + username);
      updateNav();
      showSection('home');
      e.target.reset();

      const userRef = db.ref('presence/' + currentUser.username);
      userRef.set({
          lastOnline: firebase.database.ServerValue.TIMESTAMP
      });
      userRef.onDisconnect().remove();
    }).catch(err => {
      alert('Erreur: ' + err.message);
    });
  }

  // Inscription
  function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if(!username || !password) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    if(password.length < 4) {
      alert('Le mot de passe doit faire au moins 4 caractères');
      return;
    }
    db.ref('users/' + username).once('value').then(snap => {
      if(snap.exists()) {
        alert('Nom d\'utilisateur déjà pris');
        return;
      }
      db.ref('users/' + username).set({
        password: password,
        admin: false,
        staff: false,
        role: '',
        gems: 50,
      }).then(() => {
        alert('Compte créé, vous pouvez maintenant vous connecter.');
        showSection('login');
      });
    }).catch(err => alert('Erreur : ' + err.message));
  }

  // Déconnexion
  function logoutUser() {
    if(confirm('Voulez-vous vous déconnecter ?')) {
      if (currentUser) {
        db.ref('presence/' + currentUser.username).remove();
      }
      currentUser = null;
      updateNav();
      showSection('home');
    }
  }

  // --- STAFF ---
  let staffListener = null;

  function loadStaff() {
    const ul = document.getElementById('staffList');
    ul.innerHTML = '<i>Chargement...</i>';

    if (staffListener) {
      db.ref('staff').off('value', staffListener);
    }

    staffListener = snap => {
      const staff = snap.val() || {};
      ul.innerHTML = '';
      let staffEntries = Object.entries(staff);

      staffEntries.sort(([,a], [,b]) => (a.order || 0) - (b.order || 0));

      if (staffEntries.length === 0) {
        ul.innerHTML = '<i>Aucun membre du staff pour le moment.</i>';
      } else {
        staffEntries.forEach(([pseudo, info], index) => {
          const li = document.createElement('li');
          li.className = 'staff-item';
          li.innerHTML = `<span>${pseudo} - ${info.role || 'Rôle inconnu'}</span>`;

          if(currentUser && currentUser.admin) {
            const moveUpBtn = document.createElement('button');
            moveUpBtn.textContent = 'Up';
            moveUpBtn.className = 'move-btn';
            moveUpBtn.disabled = index === 0;
            moveUpBtn.onclick = () => moveStaffMember(pseudo, 'up');
            li.appendChild(moveUpBtn);

            const moveDownBtn = document.createElement('button');
            moveDownBtn.textContent = 'Down';
            moveDownBtn.className = 'move-btn';
            moveDownBtn.disabled = index === staffEntries.length - 1;
            moveDownBtn.onclick = () => moveStaffMember(pseudo, 'down');
            li.appendChild(moveDownBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'Modifier Rôle';
            editBtn.className = 'edit-btn';
            editBtn.onclick = () => editStaffRole(pseudo, info.role);
            li.appendChild(editBtn);

            const delBtn = document.createElement('button');
            delBtn.textContent = 'Supprimer';
            delBtn.className = 'delete-btn';
            delBtn.onclick = () => deleteStaffMember(pseudo);
            li.appendChild(delBtn);
          }
          ul.appendChild(li);
        });
      }
    };
    db.ref('staff').on('value', staffListener);
  }

  async function addStaffMember() {
    const pseudo = document.getElementById('newStaffPseudo').value.trim();
    const role = document.getElementById('newStaffRole').value.trim();
    if(!pseudo || !role) {
      alert('Veuillez remplir le pseudo et le rôle.');
      return;
    }
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé. Seuls les admins peuvent ajouter des membres du staff.');
        return;
    }

    try {
        const snapshot = await db.ref('staff').orderByChild('order').limitToLast(1).once('value');
        let maxOrder = 0;
        snapshot.forEach(childSnap => {
            if (childSnap.val() && childSnap.val().order > maxOrder) {
                maxOrder = childSnap.val().order;
            }
        });
        const newOrder = maxOrder + 1;

        await db.ref('staff/' + pseudo).set({role, order: newOrder});
        alert(`${pseudo} a été ajouté au staff avec le rôle : ${role}.`);
        document.getElementById('newStaffPseudo').value = '';
        document.getElementById('newStaffRole').value = '';
    } catch (e) {
        alert('Erreur: ' + e.message);
    }
  }

  function deleteStaffMember(pseudo) {
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé. Seuls les admins peuvent supprimer des membres du staff.');
        return;
    }
    if(confirm(`Voulez-vous vraiment supprimer ${pseudo} du staff ?`)) {
      db.ref('staff/' + pseudo).remove()
        .then(() => {
          alert(`${pseudo} a été supprimé du staff.`);
        }).catch(e => alert('Erreur lors de la suppression: ' + e.message));
    }
  }

  function editStaffRole(pseudo, currentRole) {
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé. Seuls les admins peuvent modifier les rôles du staff.');
        return;
    }
    const newRole = prompt(`Modifier le rôle de ${pseudo}. Rôle actuel: "${currentRole}"`, currentRole);
    if (newRole !== null && newRole.trim() !== '') {
      db.ref('staff/' + pseudo).update({role: newRole.trim()})
        .then(() => {
          alert(`Le rôle de ${pseudo} a été mis à jour à "${newRole}".`);
        }).catch(e => alert('Erreur lors de la mise à jour du rôle: ' + e.message));
    } else if (newRole !== null) {
        alert('Le rôle ne peut pas être vide.');
    }
  }

  async function moveStaffMember(pseudoToMove, direction) {
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé. Seuls les admins peuvent réordonner le staff.');
        return;
    }

    try {
        const snapshot = await db.ref('staff').orderByChild('order').once('value');
        let staffArray = [];
        snapshot.forEach(childSnap => {
            staffArray.push({pseudo: childSnap.key, ...childSnap.val()});
        });

        const currentIndex = staffArray.findIndex(s => s.pseudo === pseudoToMove);
        if (currentIndex === -1) return;

        let targetIndex = -1;
        if (direction === 'up' && currentIndex > 0) {
            targetIndex = currentIndex - 1;
        } else if (direction === 'down' && currentIndex < staffArray.length - 1) {
            targetIndex = currentIndex + 1;
        }

        if (targetIndex !== -1) {
            const currentStaff = staffArray[currentIndex];
            const targetStaff = staffArray[targetIndex];

            await db.ref('staff/' + currentStaff.pseudo).update({order: targetStaff.order});
            await db.ref('staff/' + targetStaff.pseudo).update({order: currentStaff.order});
        }
    } catch (e) {
        alert('Erreur lors du déplacement du membre du staff: ' + e.message);
        console.error(e);
    }
  }

  // --- WIKI ---

  let annoncesListener = null;
  let problemesListener = null;
  let autresListener = null;

  function loadWiki() {
    if(annoncesListener) db.ref('wiki/annonces').off('value', annoncesListener);
    if(problemesListener) db.ref('wiki/problemes').off('value', problemesListener);
    if(autresListener) db.ref('wiki/autres').off('value', autresListener);

    const annoncesDiv = document.getElementById('annoncesList');
    annoncesDiv.innerHTML = '<i>Chargement...</i>';
    annoncesListener = snap => {
      const data = snap.val() || {};
      annoncesDiv.innerHTML = '';
      const entries = Object.entries(data);
      if(entries.length === 0) annoncesDiv.innerHTML = '<i>Aucune annonce.</i>';
      else entries.forEach(([, item]) => {
        const d = document.createElement('div');
        d.className = 'message';
        d.innerHTML = `<strong>${item.author}</strong> : ${item.text}`;
        annoncesDiv.appendChild(d);
      });
    };
    db.ref('wiki/annonces').on('value', annoncesListener);

    const problemesDiv = document.getElementById('problemesList');
    problemesDiv.innerHTML = '<i>Chargement...</i>';
    problemesListener = snap => {
      const data = snap.val() || {};
      problemesDiv.innerHTML = '';
      const entries = Object.entries(data);
      if(entries.length === 0) problemesDiv.innerHTML = '<i>Aucun problème signalé.</i>';
      else entries.forEach(([, item]) => {
        const d = document.createElement('div');
        d.className = 'message';
        d.innerHTML = `<strong>${item.author}</strong> : ${item.text}`;
        problemesDiv.appendChild(d);
      });
    };
    db.ref('wiki/problemes').on('value', problemesListener);

    const autresDiv = document.getElementById('autresList');
    autresDiv.innerHTML = '<i>Chargement...</i>';
    autresListener = snap => {
      const data = snap.val() || {};
      autresDiv.innerHTML = '';
      const entries = Object.entries(data);
      if(entries.length === 0) autresDiv.innerHTML = '<i>Pas encore de messages.</i>';
      else entries.forEach(([, item]) => {
        const d = document.createElement('div');
        d.className = 'message';
        d.innerHTML = `<strong>${item.author}</strong> : ${item.text}`;
        autresDiv.appendChild(d);
      });
    };
    db.ref('wiki/autres').on('value', autresListener);
  }

  function postAnnonce() {
    const text = document.getElementById('annonceInput').value.trim();
    if(!text) return alert('Message vide');
    if(!currentUser || !currentUser.admin) return alert('Accès refusé');
    const newKey = db.ref('wiki/annonces').push().key;
    db.ref('wiki/annonces/' + newKey).set({
      text: text,
      author: currentUser.username,
      date: Date.now()
    }).then(() => {
      document.getElementById('annonceInput').value = '';
    }).catch(e => alert('Erreur : ' + e.message));
  }
  function postProbleme() {
    const text = document.getElementById('problemeInput').value.trim();
    if(!text) return alert('Message vide');
    if(!currentUser) return alert('Connectez-vous pour poster');
    const newKey = db.ref('wiki/problemes').push().key;
    db.ref('wiki/problemes/' + newKey).set({
      text,
      author: currentUser.username,
      date: Date.now()
    }).then(() => {
      document.getElementById('problemeInput').value = '';
    }).catch(e => alert('Erreur : ' + e.message));
  }
  function postAutre() {
    const text = document.getElementById('autreInput').value.trim();
    if(!text) return alert('Message vide');
    if(!currentUser) return alert('Connectez-vous pour poster');
    const newKey = db.ref('wiki/autres').push().key;
    db.ref('wiki/autres/' + newKey).set({
      text,
      author: currentUser.username,
      date: Date.now()
    }).then(() => {
      document.getElementById('autreInput').value = '';
    }).catch(e => alert('Erreur : ' + e.message));
  }

  // --- SHOP AND GRADES (COMBINED) ---

  let shopItemsListener = null;
  let gradesListener = null;

  function loadShopAndGrades() {
    if (shopItemsListener) db.ref('shop').off('value', shopItemsListener);
    if (gradesListener) db.ref('grades').off('value', gradesListener);

    const shopItemsDiv = document.getElementById('shopItems');
    shopItemsDiv.innerHTML = '<i>Chargement des articles...</i>';

    const gradesListDiv = document.getElementById('gradesList');
    gradesListDiv.innerHTML = '<i>Chargement des grades...</i>';

    const playerGemsDisplayShop = document.getElementById('playerGemsDisplayShop');
    if (currentUser) {
        db.ref('users/' + currentUser.username + '/gems').on('value', snap => {
            currentUser.gems = snap.val() || 0;
            playerGemsDisplayShop.textContent = `Vos gemmes : ${currentUser.gems} 💎`;
            db.ref('shop').once('value').then(s => renderShopItems(s.val()));
            db.ref('grades').once('value').then(s => renderGrades(s.val()));
        });
    } else {
        playerGemsDisplayShop.textContent = 'Connectez-vous pour voir vos gemmes.';
    }

    shopItemsListener = db.ref('shop').on('value', snap => {
      renderShopItems(snap.val());
    });

    gradesListener = db.ref('grades').on('value', snap => {
      renderGrades(snap.val());
    });
  }

  function renderShopItems(items) {
      const shopItemsDiv = document.getElementById('shopItems');
      shopItemsDiv.innerHTML = '';

      if (!items || Object.keys(items).length === 0) {
        shopItemsDiv.innerHTML = '<p>Aucun article disponible pour le moment.</p>';
      } else {
        const itemGrid = document.createElement('div');
        itemGrid.className = 'shop-item-grid';

        Object.entries(items).forEach(([id, item]) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'shop-item';
          itemDiv.innerHTML = `
            <h3>${item.name}</h3>
            <p>${item.description}</p>
            <p><strong>Prix : ${item.price} gemmes</strong></p>
          `;
          const buyButton = document.createElement('button');
          buyButton.textContent = 'Acheter';
          buyButton.disabled = !currentUser || (currentUser.gems < item.price);
          buyButton.onclick = () => buyShopItem(id, item.name, item.price);
          itemDiv.appendChild(buyButton);

          if (currentUser && currentUser.admin) {
            const adminControls = document.createElement('div');
            adminControls.className = 'admin-controls';
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Supprimer';
            deleteButton.style.background = 'red';
            deleteButton.onclick = () => deleteShopItem(id, item.name);
            adminControls.appendChild(deleteButton);
            itemDiv.appendChild(adminControls);
          }
          itemGrid.appendChild(itemDiv);
        });
        shopItemsDiv.appendChild(itemGrid);
      }
  }

  function renderGrades(grades) {
      const gradesListDiv = document.getElementById('gradesList');
      gradesListDiv.innerHTML = '';

      if (!grades || Object.keys(grades).length === 0) {
        gradesListDiv.innerHTML = '<p>Aucun grade disponible pour le moment.</p>';
      } else {
        const gradeGrid = document.createElement('div');
        gradeGrid.className = 'shop-grade-grid';

        Object.entries(grades).forEach(([id, grade]) => {
          const gradeDiv = document.createElement('div');
          gradeDiv.className = 'shop-grade-item';
          gradeDiv.innerHTML = `
            <h3>${grade.name}</h3>
            <p>${grade.description}</p>
            <p><strong>Coût : ${grade.cost} gemmes</strong></p>
          `;

          const buyButton = document.createElement('button');
          buyButton.textContent = 'Acheter le grade';
          buyButton.disabled = !currentUser || currentUser.gems < grade.cost;
          buyButton.onclick = () => buyGrade(id, grade.name, grade.cost);
          gradeDiv.appendChild(buyButton);

          if (currentUser && currentUser.admin) {
            const adminControls = document.createElement('div');
            adminControls.className = 'admin-controls';
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Supprimer';
            deleteButton.style.background = 'red';
            deleteButton.onclick = () => deleteGrade(id, grade.name);
            adminControls.appendChild(deleteButton);
            gradeDiv.appendChild(adminControls);
          }
          gradeGrid.appendChild(gradeDiv);
        });
        gradesListDiv.appendChild(gradeGrid);
      }
  }

  function addShopItem() {
    const name = document.getElementById('newItemName').value.trim();
    const price = parseInt(document.getElementById('newItemPrice').value.trim());
    const description = document.getElementById('newItemDescription').value.trim();

    if (!name || !description || isNaN(price) || price < 0) {
      alert('Veuillez remplir tous les champs correctement (le prix doit être un nombre positif).');
      return;
    }

    if (!currentUser || !currentUser.admin) {
      alert('Accès refusé. Seuls les admins peuvent ajouter des articles.');
      return;
    }

    const newKey = db.ref('shop').push().key;
    db.ref('shop/' + newKey).set({
      name: name,
      price: price,
      description: description,
      addedBy: currentUser.username,
      dateAdded: Date.now()
    }).then(() => {
      alert('Article ajouté au shop !');
      document.getElementById('newItemName').value = '';
      document.getElementById('newItemPrice').value = '';
      document.getElementById('newItemDescription').value = '';
    }).catch(e => alert('Erreur lors de l\'ajout : ' + e.message));
  }

  async function buyShopItem(itemId, itemName, itemPrice) {
    if (!currentUser) {
      alert('Vous devez être connecté pour acheter des articles.');
      return;
    }
    if (currentUser.gems < itemPrice) {
      alert('Vous n\'avez pas assez de gemmes pour acheter cet article.');
      return;
    }

    const confirmation = confirm(`Confirmez-vous l'achat de "${itemName}" pour ${itemPrice} gemmes ?`);
    if (!confirmation) return;

    try {
        const userRef = db.ref(`users/${currentUser.username}/gems`);
        await userRef.transaction(currentGems => {
            if (currentGems === null) return 0;
            if (currentGems < itemPrice) {
                alert('Transaction annulée : pas assez de gemmes.');
                return;
            }
            return currentGems - itemPrice;
        }, (error, committed, snapshot) => {
            if (error) {
                console.error("Transaction failed abnormally!", error);
                alert('Erreur lors de la déduction des gemmes : ' + error.message);
            } else if (!committed) {
                console.log("Transaction aborted (e.g., not enough gems).");
            } else {
                console.log("Gems successfully deducted. New balance:", snapshot.val());
                const newNotificationKey = db.ref('notifications/shop').push().key;
                db.ref('notifications/shop/' + newNotificationKey).set({
                  type: 'item_purchase',
                  itemId: itemId,
                  itemName: itemName,
                  itemPrice: itemPrice,
                  buyer: currentUser.username,
                  date: firebase.database.ServerValue.TIMESTAMP,
                  status: 'pending'
                }).then(() => {
                    alert(`Achat de "${itemName}" effectué. ${itemPrice} gemmes déduites. Une notification a été envoyée au staff.`);
                }).catch(e => {
                    alert('Achat effectué, mais erreur lors de l\'envoi de la notification au staff : ' + e.message);
                    console.error(e);
                });
            }
        });

    } catch (e) {
        alert('Erreur inattendue lors de l\'achat : ' + e.message);
        console.error(e);
    }
  }

  function deleteShopItem(itemId, itemName) {
    if (!currentUser || !currentUser.admin) {
      alert('Accès refusé. Seuls les admins peuvent supprimer des articles.');
      return;
    }
    if (confirm(`Voulez-vous vraiment supprimer l'article "${itemName}" du shop ?`)) {
      db.ref('shop/' + itemId).remove().then(() => {
        alert('Article supprimé.');
      }).catch(e => alert('Erreur lors de la suppression : ' + e.message));
    }
  }

  function addGradeItem() {
    const name = document.getElementById('newGradeName').value.trim();
    const cost = parseInt(document.getElementById('newGradeCost').value.trim());
    const description = document.getElementById('newGradeDescription').value.trim();

    if (!name || !description || isNaN(cost) || cost < 0) {
      alert('Veuillez remplir tous les champs correctement (le coût doit être un nombre positif).');
      return;
    }

    if (!currentUser || !currentUser.admin) {
      alert('Accès refusé. Seuls les admins peuvent ajouter des grades.');
      return;
    }

    const newKey = db.ref('grades').push().key;
    db.ref('grades/' + newKey).set({
      name: name,
      cost: cost,
      description: description,
      addedBy: currentUser.username,
      dateAdded: Date.now()
    }).then(() => {
      alert('Grade ajouté !');
      document.getElementById('newGradeName').value = '';
      document.getElementById('newGradeCost').value = '';
      document.getElementById('newGradeDescription').value = '';
    }).catch(e => alert('Erreur lors de l\'ajout : ' + e.message));
  }

  async function buyGrade(gradeId, gradeName, gradeCost) {
    if (!currentUser) {
      alert('Vous devez être connecté pour acheter des grades.');
      return;
    }
    if (currentUser.gems < gradeCost) {
      alert('Vous n\'avez pas assez de gemmes pour acheter ce grade.');
      return;
    }

    if (confirm(`Voulez-vous vraiment acheter le grade "${gradeName}" pour ${gradeCost} gemmes ?`)) {
      try {
        const userRef = db.ref(`users/${currentUser.username}/gems`);
        await userRef.transaction(currentGems => {
            if (currentGems === null) return 0;
            if (currentGems < gradeCost) {
                alert('Transaction annulée : pas assez de gemmes.');
                return;
            }
            return currentGems - gradeCost;
        }, (error, committed, snapshot) => {
            if (error) {
                console.error("Transaction failed abnormally!", error);
                alert('Erreur lors de la déduction des gemmes : ' + error.message);
            } else if (!committed) {
                console.log("Transaction aborted (e.g., not enough gems).");
            } else {
                console.log("Gems successfully deducted. New balance:", snapshot.val());
                const newNotificationKey = db.ref('notifications/shop').push().key;
                db.ref('notifications/shop/' + newNotificationKey).set({
                  type: 'grade_purchase',
                  gradeId: gradeId,
                  gradeName: gradeName,
                  gradeCost: gradeCost,
                  buyer: currentUser.username,
                  date: firebase.database.ServerValue.TIMESTAMP,
                  status: 'pending'
                }).then(() => {
                    alert(`Achat du grade "${gradeName}" effectué. ${gradeCost} gemmes déduites. Une notification a été envoyée au staff.`);
                }).catch(e => {
                    alert('Achat effectué, mais erreur lors de l\'envoi de la notification au staff : ' + e.message);
                    console.error(e);
                });
            }
        });
      } catch (e) {
        alert('Erreur inattendue lors de l\'achat du grade : ' + e.message);
        console.error(e);
      }
    }
  }

  function deleteGrade(gradeId, gradeName) {
    if (!currentUser || !currentUser.admin) {
      alert('Accès refusé. Seuls les admins peuvent supprimer des grades.');
      return;
    }
    if (confirm(`Voulez-vous vraiment supprimer le grade "${gradeName}" ?`)) {
      db.ref('grades/' + gradeId).remove().then(() => {
        alert('Grade supprimé.');
      }).catch(e => alert('Erreur lors de la suppression : ' + e.message));
    }
  }

  // --- NOTIFICATIONS (Staff Only) ---

  let notificationsListener = null;

  function loadNotifications() {
      if (notificationsListener) db.ref('notifications/shop').off('value', notificationsListener);

      const pendingDiv = document.getElementById('pendingNotifications');
      const onHoldDiv = document.getElementById('onHoldNotifications');
      const doneDiv = document.getElementById('doneNotifications');

      pendingDiv.innerHTML = '<i>Aucune notification en cours.</i>';
      onHoldDiv.innerHTML = '<i>Aucune notification en attente.</i>';
      doneDiv.innerHTML = '<i>Aucune notification traitée.</i>';

      const renderNotifications = (notificationsData) => {
          pendingDiv.innerHTML = '';
          onHoldDiv.innerHTML = '';
          doneDiv.innerHTML = '';

          let hasPending = false;
          let hasOnHold = false;
          let hasDone = false;

          Object.entries(notificationsData || {}).forEach(([id, notif]) => {
              const notifDiv = document.createElement('div');
              notifDiv.className = `notification-item status-${notif.status}`;
              const date = notif.date ? new Date(notif.date).toLocaleString('fr-FR') : 'Date inconnue';

              let message = '';
              let price = 0;
              if (notif.type === 'item_purchase') {
                  message = `**Article** : ${notif.itemName}`;
                  price = notif.itemPrice;
              } else if (notif.type === 'grade_purchase') {
                  message = `**Grade** : ${notif.gradeName}`;
                  price = notif.gradeCost;
              } else {
                  message = 'Type de notification inconnu';
              }

              notifDiv.innerHTML = `
                <div class="notif-header">
                    <strong>Achat par ${notif.buyer}</strong>
                    <span class="notif-status">${notif.status === 'pending' ? 'En cours' : (notif.status === 'onhold' ? 'En attente' : 'Traitée')}</span>
                </div>
                <div class="notif-message">
                    ${message} (Prix : ${price} gemmes)
                </div>
                <div class="notif-date">Demandé le : ${date}</div>
                <div class="notif-actions">
                    ${notif.status !== 'done' ? `<button class="mark-done" onclick="updateNotificationStatus('${id}', 'done', '${notif.buyer}', ${price})">Marquer comme fait</button>` : ''}
                    ${notif.status !== 'onhold' ? `<button class="put-hold" onclick="updateNotificationStatus('${id}', 'onhold')">Mettre en attente</button>` : ''}
                    <button class="delete-notif" onclick="deleteNotification('${id}', '${message}', '${notif.buyer}')">Supprimer</button>
                </div>
              `;

              if (notif.status === 'pending') {
                  pendingDiv.appendChild(notifDiv);
                  hasPending = true;
              } else if (notif.status === 'onhold') {
                  onHoldDiv.appendChild(notifDiv);
                  hasOnHold = true;
              } else if (notif.status === 'done') {
                  doneDiv.appendChild(notifDiv);
                  hasDone = true;
              }
          });

          if (!hasPending) pendingDiv.innerHTML = '<i>Aucune notification en cours.</i>';
          if (!hasOnHold) onHoldDiv.innerHTML = '<i>Aucune notification en attente.</i>';
          if (!hasDone) doneDiv.innerHTML = '<i>Aucune notification traitée.</i>';
      };

      notificationsListener = db.ref('notifications/shop').on('value', (snapshot) => {
          renderNotifications(snapshot.val());
      });
  }

  async function updateNotificationStatus(notificationId, newStatus, buyerUsername, amount) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent gérer les notifications.');
          return;
      }

      if (newStatus === 'done') {
          const confirmDone = confirm(`Confirmez-vous que l'achat pour ${buyerUsername} (${amount} gemmes) a été appliqué en jeu ?
          \n(Note: Les gemmes ont déjà été déduites au moment de l'achat. Ce bouton sert à marquer la tâche comme effectuée pour le staff.)`);

          if (!confirmDone) return;
      }

      db.ref('notifications/shop/' + notificationId).update({ status: newStatus })
          .then(() => {})
          .catch(e => alert('Erreur lors de la mise à jour de la notification : ' + e.message));
  }


  function deleteNotification(notificationId, itemName, buyer) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent supprimer des notifications.');
          return;
      }
      if (confirm(`Voulez-vous vraiment supprimer la notification pour l'achat de "${itemName}" par ${buyer} ?`)) {
          db.ref('notifications/shop/' + notificationId).remove()
              .then(() => {})
              .catch(e => alert('Erreur lors de la suppression : ' + e.message));
      }
  }

  // --- SERVER STATUS ---
  let serverStatusListener = null;

  function loadServerStatus() {
      if (serverStatusListener) db.ref('serverStatus').off('value', serverStatusListener);

      const statusDisplay = document.getElementById('serverStatusDisplay');
      const newStatusSelect = document.getElementById('newServerStatus');

      statusDisplay.textContent = 'Chargement du statut...';
      statusDisplay.className = 'status-loading';

      serverStatusListener = db.ref('serverStatus').on('value', (snapshot) => {
          const status = snapshot.val();
          if (status && status.currentStatus) {
              const displayStatus = status.currentStatus;
              statusDisplay.textContent = `Serveur: ${
                displayStatus === 'open' ? 'Ouvert' :
                displayStatus === 'closed' ? 'Fermé' :
                'En Développement'
              }`;
              statusDisplay.className = `status-${displayStatus}`;

              newStatusSelect.value = displayStatus;
          } else {
              statusDisplay.textContent = 'Statut inconnu.';
              statusDisplay.className = '';
          }
      }, (error) => {
          console.error("Firebase Server Status Error:", error);
          statusDisplay.textContent = 'Erreur de chargement du statut.';
          statusDisplay.className = 'status-error';
      });
  }

  function updateServerStatus() {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent modifier le statut du serveur.');
          return;
      }
      const newStatus = document.getElementById('newServerStatus').value;
      if (confirm(`Voulez-vous changer le statut du serveur à "${newStatus}" ?`)) {
          db.ref('serverStatus').set({
              currentStatus: newStatus,
              lastUpdatedBy: currentUser.username,
              lastUpdatedAt: Date.now()
          }).then(() => {
              alert('Statut du serveur mis à jour.');
          }).catch(e => alert('Erreur lors de la mise à jour du statut : ' + e.message));
      }
  }

  // --- ONLINE USERS ---
  let onlineUsersListener = null;

  function loadOnlineUsers() {
      if (!currentUser || !currentUser.admin) return;

      if (onlineUsersListener) db.ref('presence').off('value', onlineUsersListener);

      const onlineUsersListDiv = document.getElementById('onlineUsersList');
      onlineUsersListDiv.innerHTML = '<i>Chargement des utilisateurs en ligne...</i>';

      onlineUsersListener = db.ref('presence').on('value', (snapshot) => {
          const onlineUsers = snapshot.val() || {};
          onlineUsersListDiv.innerHTML = '';
          const userEntries = Object.entries(onlineUsers);

          if (userEntries.length === 0) {
              onlineUsersListDiv.innerHTML = '<i>Aucun utilisateur en ligne pour le moment.</i>';
          }
          else {
              userEntries.forEach(([username, data]) => {
                  const userDiv = document.createElement('div');
                  userDiv.className = 'online-user-item';
                  const lastOnlineDate = new Date(data.lastOnline).toLocaleString('fr-FR');
                  userDiv.innerHTML = `
                    <strong>${username}</strong>
                    <span>Dernière activité : ${lastOnlineDate}</span>
                  `;
                  onlineUsersListDiv.appendChild(userDiv);
              });
          }
      }, (error) => {
          console.error("Firebase Online Users Error:", error);
          onlineUsersListDiv.innerHTML = '<i>Erreur de chargement des utilisateurs en ligne.</i>';
      });
  }

  // --- COMPTE (gestion admin) ---

  function loadUsers() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    if (!currentUser || !currentUser.admin) {
        tbody.innerHTML = '<tr><td colspan="4">Accès administrateur requis pour la gestion des utilisateurs.</td></tr>';
        return;
    }

    tbody.innerHTML = 'Chargement...';
    db.ref('users').once('value').then(snapshot => {
      const users = snapshot.val();
      tbody.innerHTML = '';
      if(!users) {
        tbody.innerHTML = '<tr><td colspan="4">Aucun utilisateur</td></tr>';
        return;
      }
      Object.entries(users).forEach(([username, data]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${username}</td>
          <td>${data.admin ? 'Oui' : 'Non'}</td>
          <td>${data.gems !== undefined ? data.gems : 0}</td>
          <td>
            ${currentUser.admin && username !== currentUser.username ? `
              <button onclick="toggleAdmin('${username}', ${data.admin})">${data.admin ? 'Retirer admin' : 'Donner admin'}</button>
              <button onclick="deleteUser('${username}')">Supprimer</button>
            ` : ''}
            ${currentUser.admin ? `
              <br><br>
              <input type="number" id="gemsInput_${username}" class="user-table-gems-input" value="${data.gems !== undefined ? data.gems : 0}">
              <button onclick="updateGems('${username}', document.getElementById('gemsInput_${username}').value)">Mettre à jour gemmes</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }).catch(e => {
      tbody.innerHTML = '<tr><td colspan="4">Erreur chargement utilisateurs</td></tr>';
      console.error("Error loading users:", e);
    });
  }

  async function toggleAdmin(username, isAdmin) {
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé.');
        return;
    }
    if(!confirm(`Voulez-vous vraiment ${isAdmin ? 'retirer' : 'donner'} le rôle admin à ${username} ?`)) return;

    try {
        await db.ref('users/' + username + '/admin').set(!isAdmin);
        alert(`Statut admin de ${username} mis à jour.`);
        loadUsers();

        if (currentUser && currentUser.username === username) {
            currentUser.admin = !isAdmin;
            updateUIForAdminStatus();
        }
    } catch(e) {
        alert('Erreur : ' + e.message);
    }
  }

  function deleteUser(username) {
    if (!currentUser || !currentUser.admin) {
        alert('Accès refusé.');
        return;
    }
    if(!confirm(`Supprimer l'utilisateur ${username} ?`)) return;
    db.ref('users/' + username).remove().then(loadUsers)
      .catch(e => alert('Erreur : ' + e.message));
  }

  function updateGems(username, newGemsValue) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent modifier les gemmes.');
          return;
      }
      const gems = parseInt(newGemsValue);
      if (isNaN(gems)) {
          alert('Veuillez entrer une valeur numérique valide pour les gemmes.');
          return;
      }
      if (confirm(`Voulez-vous définir les gemmes de ${username} à ${gems} ?`)) {
          db.ref(`users/${username}/gems`).set(gems)
              .then(() => {
                  alert(`Les gemmes de ${username} ont été mises à jour à ${gems}.`);
                  loadUsers();
                  if (currentUser && currentUser.username === username) {
                      currentUser.gems = gems;
                      updateUIForAdminStatus();
                  }
              })
              .catch(e => alert('Erreur lors de la mise à jour des gemmes : ' + e.message));
      }
  }

  // --- BACKGROUND IMAGE FUNCTIONALITY ---
  function loadBackgrounds() {
    if (backgroundsListener) {
        db.ref('backgrounds').off('value', backgroundsListener);
    }
    backgroundsListener = db.ref('backgrounds').on('value', (snapshot) => {
        backgrounds = snapshot.val() || {};
        if (currentUser && currentUser.admin) {
            Object.keys(backgrounds).forEach(section => {
                const inputElement = document.getElementById(`${section}BgUrl`);
                if (inputElement) {
                    inputElement.value = backgrounds[section];
                }
            });
        }
        applyBackground(currentSection);
    }, (error) => {
        console.error("Error loading backgrounds:", error);
    });
  }

  function applyBackground(sectionName) {
      const sectionElement = document.getElementById(sectionName);
      if (sectionElement && backgrounds[sectionName]) {
          sectionElement.style.backgroundImage = `url('${backgrounds[sectionName]}')`;
      } else if (sectionElement) {
          sectionElement.style.backgroundImage = 'none'; // Remove background if none set
      }
  }

  async function handleImageUpload(event, sectionName) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent modifier les fonds d\'écran.');
          return;
      }

      const file = event.target.files[0];
      if (!file) return;

      const spinner = document.getElementById(`${sectionName}Spinner`);
      const urlInput = document.getElementById(`${sectionName}BgUrl`);
      spinner.style.display = 'inline-block';

      const storageRef = storage.ref(`backgrounds/${sectionName}/${file.name}`);
      try {
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();

          urlInput.value = downloadURL;
          await saveBackground(sectionName, downloadURL);
          alert(`Image pour "${sectionName}" téléchargée et sauvegardée.`);
      } catch (e) {
          console.error("Error uploading image:", e);
          alert('Erreur lors du téléchargement de l\'image : ' + e.message);
      } finally {
          spinner.style.display = 'none';
          event.target.value = '';
      }
  }

  async function saveBackground(sectionName, url = null) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent modifier les fonds d\'écran.');
          return;
      }
      const urlInput = document.getElementById(`${sectionName}BgUrl`);
      const imageUrl = url || urlInput.value.trim();

      if (!imageUrl) {
          if (confirm(`Voulez-vous supprimer l'image de fond pour la section "${sectionName}" ?`)) {
              await deleteBackground(sectionName);
          }
      } else {
          db.ref(`backgrounds/${sectionName}`).set(imageUrl)
              .then(() => alert(`Image de fond pour "${sectionName}" sauvegardée.`))
              .catch(e => alert('Erreur lors de la sauvegarde : ' + e.message));
      }
  }

  async function deleteBackground(sectionName) {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent supprimer les fonds d\'écran.');
          return;
      }

      const currentImageUrl = backgrounds[sectionName];
      const urlInput = document.getElementById(`${sectionName}BgUrl`);

      try {
          await db.ref(`backgrounds/${sectionName}`).remove();

          if (currentImageUrl && currentImageUrl.includes('firebasestorage.googleapis.com')) {
              const parts = currentImageUrl.split('/');
              const filenameWithToken = parts[parts.length - 1];
              const filename = filenameWithToken.split('?')[0];

              const path = `backgrounds/${sectionName}/${filename}`;
              const imageRef = storage.ref(path);
              try {
                  await imageRef.delete();
                  console.log('Image deleted from Storage:', path);
              } catch (e) {
                  if (e.code === 'storage/object-not-found') {
                      console.warn('Image not found in Storage, perhaps it was an external URL or already deleted.', e);
                  } else {
                      console.error('Error deleting image from Storage:', e);
                  }
              }
          }

          urlInput.value = '';
          applyBackground(sectionName);
          alert(`Image de fond pour "${sectionName}" supprimée.`);
      } catch (e) {
          alert('Erreur lors de la suppression de l\'image : ' + e.message);
          console.error(e);
      }
  }

  function updateAdminBackgroundControlsVisibility() {
      const adminControls = document.querySelectorAll('.admin-background-controls');
      const toggleCheckbox = document.getElementById('toggleAdminBgControls');
      const adminToggleContainer = document.getElementById('adminBgToggleContainer');

      if (currentUser && currentUser.admin) {
        adminToggleContainer.style.display = 'block';
      } else {
        adminToggleContainer.style.display = 'none';
        toggleCheckbox.checked = false;
      }

      adminControls.forEach(controlDiv => {
          const sectionId = controlDiv.id.replace('AdminBgControls', '');
          if (currentUser && currentUser.admin && toggleCheckbox.checked && sectionId === currentSection) {
              controlDiv.classList.add('active');
          } else {
              controlDiv.classList.remove('active');
          }
      });
  }

  // --- PRIVATE MESSAGING SYSTEM ---
  function getChatRoomId(user1, user2) {
      return [user1, user2].sort().join('_');
  }

  function loadRecentConversations() {
      if (!currentUser) return;

      const recentConversationsDiv = document.getElementById('recentConversations');
      recentConversationsDiv.innerHTML = '<p><i>Chargement des conversations...</i></p>';

      const userRef = db.ref(`userConversations/${currentUser.username}`);
      userRef.on('value', (snapshot) => {
          const conversations = snapshot.val() || {};
          recentConversationsDiv.innerHTML = '';
          const conversationPartners = Object.entries(conversations)
              .map(([partner, data]) => ({ partner, lastMessageTimestamp: data.lastMessageTimestamp || 0 }))
              .sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);

          if (conversationPartners.length === 0) {
              recentConversationsDiv.innerHTML = '<p><i>Aucune conversation récente.</i></p>';
          } else {
              conversationPartners.forEach(({ partner }) => {
                  const itemDiv = document.createElement('div');
                  itemDiv.className = 'user-contact-item';
                  if (activeChatPartner === partner) {
                      itemDiv.classList.add('active');
                  }
                  itemDiv.textContent = partner;
                  itemDiv.onclick = () => startChatWith(partner);
                  recentConversationsDiv.appendChild(itemDiv);
              });
          }
      });
  }

  async function searchUserForChat() {
      const searchInput = document.getElementById('searchUserInput').value.trim();
      const searchResultsDiv = document.getElementById('searchResults');
      searchResultsDiv.innerHTML = '';

      if (!searchInput) {
          searchResultsDiv.innerHTML = '';
          return;
      }

      if (searchInput.toLowerCase() === currentUser.username.toLowerCase()) {
          searchResultsDiv.innerHTML = '<p style="color:red;">Vous ne pouvez pas vous envoyer de message à vous-même.</p>';
          return;
      }

      const userSnapshot = await db.ref(`users/${searchInput}`).once('value');
      if (userSnapshot.exists()) {
          const resultItem = document.createElement('div');
          resultItem.className = 'search-result-item';
          resultItem.textContent = searchInput;
          resultItem.onclick = () => startChatWith(searchInput);
          searchResultsDiv.appendChild(resultItem);
      } else {
          searchResultsDiv.innerHTML = '<p>Utilisateur non trouvé.</p>';
      }
  }

  function startChatWith(partnerUsername) {
      if (!currentUser) {
          alert('Vous devez être connecté pour discuter.');
          return;
      }
      if (partnerUsername === currentUser.username) {
          alert('Vous ne pouvez pas discuter avec vous-même.');
          return;
      }

      document.querySelectorAll('.user-contact-item').forEach(item => {
          item.classList.remove('active');
      });
      const activeContactElement = Array.from(document.querySelectorAll('.user-contact-item'))
                                    .find(item => item.textContent === partnerUsername);
      if (activeContactElement) {
          activeContactElement.classList.add('active');
      }

      activeChatPartner = partnerUsername;
      document.getElementById('chatHeader').textContent = `Discussion avec ${partnerUsername}`;
      document.getElementById('messagesDisplay').innerHTML = '';
      document.getElementById('messageInput').value = '';
      document.getElementById('chatError').style.display = 'none';

      if (currentMessagesListener) {
          db.ref('messages').off('value', currentMessagesListener);
          currentMessagesListener = null;
      }

      const chatRoomId = getChatRoomId(currentUser.username, partnerUsername);
      const messagesRef = db.ref(`messages/${chatRoomId}`);

      currentMessagesListener = messagesRef.on('value', (snapshot) => {
          const messages = snapshot.val() || {};
          const messagesDisplay = document.getElementById('messagesDisplay');
          messagesDisplay.innerHTML = '';

          Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = `chat-message ${msg.sender === currentUser.username ? 'self' : 'other'}`;
              msgDiv.innerHTML = `<strong>${msg.sender}</strong>: ${msg.text}`;
              messagesDisplay.appendChild(msgDiv);
          });
          messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
      }, (error) => {
          console.error("Error loading messages:", error);
          document.getElementById('chatError').textContent = 'Erreur lors du chargement des messages.';
          document.getElementById('chatError').style.display = 'block';
      });

      db.ref(`userConversations/${currentUser.username}/${partnerUsername}`).update({lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP});
      db.ref(`userConversations/${partnerUsername}/${currentUser.username}`).update({lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP});
  }

  async function sendMessage() {
      if (!currentUser) {
          document.getElementById('chatError').textContent = 'Vous devez être connecté pour envoyer un message.';
          document.getElementById('chatError').style.display = 'block';
          return;
      }

      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();

      if (!messageText) return;

      const now = Date.now();
      if (!messageTimestamps[currentUser.username]) {
          messageTimestamps[currentUser.username] = [];
      }
      messageTimestamps[currentUser.username] = messageTimestamps[currentUser.username].filter(
          ts => now - ts < MESSAGE_RATE_LIMIT_DURATION
      );

      if (messageTimestamps[currentUser.username].length >= MAX_MESSAGES_PER_SECOND) {
          document.getElementById('chatError').textContent = `Vous envoyez des messages trop rapidement. Veuillez patienter.`;
          document.getElementById('chatError').style.display = 'block';
          setTimeout(() => {
              document.getElementById('chatError').style.display = 'none';
          }, 3000);
          return;
      }

      messageTimestamps[currentUser.username].push(now);

      let messagesRef;
      if (activeChatPartner === 'admin_group_chat') {
          if (!currentUser.admin) {
              document.getElementById('chatError').textContent = 'Seuls les admins peuvent envoyer des messages dans la discussion admin.';
              document.getElementById('chatError').style.display = 'block';
              return;
          }
          messagesRef = db.ref(`messages/admin_group_chat`);
      } else if (activeChatPartner) {
          const chatRoomId = getChatRoomId(currentUser.username, activeChatPartner);
          messagesRef = db.ref(`messages/${chatRoomId}`);
          db.ref(`userConversations/${currentUser.username}/${activeChatPartner}`).update({lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP});
          db.ref(`userConversations/${activeChatPartner}/${currentUser.username}`).update({lastMessageTimestamp: firebase.database.ServerValue.TIMESTAMP});
      } else {
          document.getElementById('chatError').textContent = 'Veuillez sélectionner un utilisateur ou un groupe pour discuter.';
          document.getElementById('chatError').style.display = 'block';
          return;
      }

      try {
          await messagesRef.push({
              sender: currentUser.username,
              text: messageText,
              timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          messageInput.value = '';
          document.getElementById('chatError').style.display = 'none';
      } catch (e) {
          console.error("Error sending message:", e);
          document.getElementById('chatError').textContent = 'Erreur lors de l\'envoi du message.';
          document.getElementById('chatError').style.display = 'block';
      }
  }

  function resetChatWindow() {
      activeChatPartner = null;
      document.getElementById('chatHeader').textContent = 'Sélectionnez une conversation';
      document.getElementById('messagesDisplay').innerHTML = '<p style="text-align: center; color: #aaa;">Sélectionnez ou recherchez un utilisateur pour commencer à discuter.</p>';
      document.getElementById('messageInput').value = '';
      document.getElementById('chatError').style.display = 'none';
      document.getElementById('searchUserInput').value = '';
      document.getElementById('searchResults').innerHTML = '';

      if (currentMessagesListener) {
          db.ref('messages').off('value', currentMessagesListener);
          currentMessagesListener = null;
      }

      document.querySelectorAll('.user-contact-item').forEach(item => {
          item.classList.remove('active');
      });
  }

  // --- ADMIN GROUP CHAT ---
  function startAdminChat() {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent accéder à cette discussion.');
          return;
      }

      document.querySelectorAll('.user-contact-item').forEach(item => {
          item.classList.remove('active');
      });
      document.querySelector('#adminChatNavLink .user-contact-item').classList.add('active');


      activeChatPartner = 'admin_group_chat';
      document.getElementById('chatHeader').textContent = `Discussion de groupe Admin`;
      document.getElementById('messagesDisplay').innerHTML = '';
      document.getElementById('messageInput').value = '';
      document.getElementById('chatError').style.display = 'none';

      if (currentMessagesListener) {
          db.ref('messages').off('value', currentMessagesListener);
          currentMessagesListener = null;
      }

      const messagesRef = db.ref(`messages/admin_group_chat`);

      currentMessagesListener = messagesRef.on('value', (snapshot) => {
          const messages = snapshot.val() || {};
          const messagesDisplay = document.getElementById('messagesDisplay');
          messagesDisplay.innerHTML = '';

          Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = `chat-message ${msg.sender === currentUser.username ? 'self' : 'other'}`;
              msgDiv.innerHTML = `<strong>${msg.sender}</strong>: ${msg.text}`;
              messagesDisplay.appendChild(msgDiv);
          });
          messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
      }, (error) => {
          console.error("Error loading admin chat messages:", error);
          document.getElementById('chatError').textContent = 'Erreur lors du chargement des messages admin.';
          document.getElementById('chatError').style.display = 'block';
      });
  }

  // --- GLOBAL MESSAGE TO ALL PLAYERS ---
  async function sendGlobalMessage() {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent envoyer des messages globaux.');
          return;
      }
      const messageInput = document.getElementById('globalMessageInput');
      const messageText = messageInput.value.trim();
      const statusDiv = document.getElementById('globalMessageStatus');

      if (!messageText) {
          statusDiv.textContent = 'Le message global ne peut pas être vide.';
          statusDiv.style.color = 'red';
          return;
      }

      if (confirm('Voulez-vous vraiment envoyer ce message à TOUS les joueurs ?')) {
          try {
              await db.ref('globalMessage').set({
                  text: messageText,
                  sender: currentUser.username,
                  timestamp: firebase.database.ServerValue.TIMESTAMP
              });
              messageInput.value = '';
              statusDiv.textContent = 'Message global envoyé avec succès !';
              statusDiv.style.color = '#0af';
          } catch (e) {
              statusDiv.textContent = 'Erreur lors de l\'envoi du message global : ' + e.message;
              statusDiv.style.color = 'red';
              console.error("Error sending global message:", e);
          }
      }
  }

  async function clearGlobalMessage() {
      if (!currentUser || !currentUser.admin) {
          alert('Accès refusé. Seuls les admins peuvent effacer le message global.');
          return;
      }
      const statusDiv = document.getElementById('globalMessageStatus');
      if (confirm('Voulez-vous vraiment effacer le message global ?')) {
          try {
              await db.ref('globalMessage').remove();
              document.getElementById('globalMessageInput').value = '';
              statusDiv.textContent = 'Message global effacé.';
              statusDiv.style.color = '#0af';
          } catch (e) {
              statusDiv.textContent = 'Erreur lors de l\'effacement du message global : ' + e.message;
              statusDiv.style.color = 'red';
              console.error("Error clearing global message:", e);
          }
      }
  }

  function loadGlobalMessage() {
      const banner = document.getElementById('globalMessageBanner');
      if (globalMessageListener) {
          db.ref('globalMessage').off('value', globalMessageListener);
      }
      globalMessageListener = db.ref('globalMessage').on('value', (snapshot) => {
          const message = snapshot.val();
          if (message && message.text) {
              banner.textContent = `📢 Annonce Admin: "${message.text}" (par ${message.sender})`;
              banner.style.display = 'block';
          } else {
              banner.textContent = '';
              banner.style.display = 'none';
          }
      }, (error) => {
          console.error("Error loading global message:", error);
          banner.textContent = 'Erreur de chargement du message global.';
          banner.style.display = 'block';
          banner.style.backgroundColor = 'darkred';
      });
  }

  // --- INIT ---

  loadBackgrounds();
  loadGlobalMessage();
  updateNav();
  showSection('home');
</script>

</body>
</html>